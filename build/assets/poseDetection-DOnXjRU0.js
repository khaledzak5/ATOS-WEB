class D{constructor(){this.pose=null,this.isInitialized=!1,this.pushupState="up",this.pushupCount=0,this.postureStatus="unknown",this.lastWarningTime=0,this.videoDimensionsLogged=!1,this.exerciseMode="pushups",this.accumulatedCorrectMs=0,this.timerRunning=!1,this.startCorrectTimestampMs=0,this.onPushupCount=null,this.onPostureChange=null,this.onFormFeedback=null,this.onTimeUpdate=null}setExerciseMode(t){const e=String(t||"").toLowerCase();e==="plank"?this.exerciseMode="plank":e==="squats"||e==="squat"?this.exerciseMode="squats":e==="lunges"||e==="lunge"?this.exerciseMode="lunges":e==="burpees"||e==="burpee"?this.exerciseMode="burpees":e.includes("mountain")||e.includes("climber")?this.exerciseMode="mountainclimbers":this.exerciseMode="pushups"}async initialize(){var t;try{if(console.log("üöÄ Initializing MediaPipe Pose..."),!window.Pose){console.warn("MediaPipe Pose not loaded yet, waiting...");let s=0;for(;!window.Pose&&s<50;)await new Promise(i=>setTimeout(i,200)),s++,s%10===0&&console.log(`Still waiting for MediaPipe... (${s*200}ms)`);if(!window.Pose)return console.error("MediaPipe Pose failed to load after waiting"),!1}console.log("‚úÖ MediaPipe Pose found in window object"),this.pose=new window.Pose({locateFile:s=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${s}`});const e=((t=window.MediaPipeConfig)==null?void 0:t.POSE_CONFIG)||{modelComplexity:0,smoothLandmarks:!0,enableSegmentation:!1,smoothSegmentation:!1,minDetectionConfidence:.5,minTrackingConfidence:.5};return this.pose.setOptions(e),this.pose.onResults(this.onResults.bind(this)),this.isInitialized=!0,console.log("MediaPipe Pose initialized successfully"),!0}catch(e){return console.error("Failed to initialize MediaPipe Pose:",e),!1}}async processFrame(t){var e;if(!this.isInitialized||!this.pose)return console.log("‚ùå Pose not initialized or missing"),null;try{if(Math.random()<.05&&console.log("üìπ Processing frame..."),t.videoWidth===0||t.videoHeight===0){Math.random()<.1&&console.log("‚è≥ Video dimensions not ready yet");return}if(this.videoDimensionsLogged||(console.log(`üìè Video dimensions: ${t.videoWidth}x${t.videoHeight}`),this.videoDimensionsLogged=!0),t.videoWidth>1920||t.videoHeight>1080){console.log("‚ö†Ô∏è Video too large (>1920x1080), skipping frame");return}await this.pose.send({image:t})}catch(s){if((e=s.message)!=null&&e.includes("memory access out of bounds")){console.warn("üîÑ Memory error, skipping frame");return}console.error("Error processing frame:",s)}}onResults(t){var s,i;if(console.log("üéØ onResults called!",t.poseLandmarks?`Found ${t.poseLandmarks.length} landmarks`:"No landmarks"),this.lastResults=t,!t.poseLandmarks){this.postureStatus="unknown",this.onPostureChange&&this.onPostureChange("unknown",null),this.timerRunning&&(this.accumulatedCorrectMs+=Date.now()-this.startCorrectTimestampMs,this.timerRunning=!1,this.startCorrectTimestampMs=0,this.onTimeUpdate&&this.onTimeUpdate(Math.floor(this.accumulatedCorrectMs/1e3)));return}const e=t.poseLandmarks;if(this.exerciseMode==="squats"||this.exerciseMode==="lunges"||this.exerciseMode==="pushups"||this.exerciseMode==="burpees")this.postureStatus="correct",this.onPostureChange&&this.onPostureChange("correct",e);else{const o=this.checkBackAlignment(e),n=o?"correct":"incorrect";if(n!==this.postureStatus&&(this.postureStatus=n,this.onPostureChange&&this.onPostureChange(this.postureStatus,e)),!o){const r=Date.now(),h=((i=(s=window.MediaPipeConfig)==null?void 0:s.PLANK_CONFIG)==null?void 0:i.WARNING_COOLDOWN)||2e3;r-this.lastWarningTime>h&&(this.playWarningSound(),this.lastWarningTime=r,this.onFormFeedback&&this.onFormFeedback({message:"Dangerous posture - straighten your back!",type:"warning",timestamp:r})),this.exerciseMode==="plank"&&this.timerRunning&&(this.accumulatedCorrectMs+=r-this.startCorrectTimestampMs,this.timerRunning=!1,this.startCorrectTimestampMs=0,this.onTimeUpdate&&this.onTimeUpdate(Math.floor(this.accumulatedCorrectMs/1e3)));return}}if(this.exerciseMode==="plank"){const o=Date.now();this.timerRunning||(this.startCorrectTimestampMs=o,this.timerRunning=!0);const n=this.accumulatedCorrectMs+(o-(this.startCorrectTimestampMs||o)),r=Math.floor(n/1e3);this.onTimeUpdate&&this.onTimeUpdate(r);return}this.exerciseMode==="squats"?this.updateSquatCounter(e):this.exerciseMode==="lunges"?this.updateLungesCounter(e):this.exerciseMode==="burpees"?this.updateBurpeesCounter(e):this.exerciseMode==="mountainclimbers"?this.updateMountainClimbersCounter(e):this.updatePushupCounter(e)}calculateAngle(t,e,s){const i=Math.atan2(s.y-e.y,s.x-e.x)-Math.atan2(t.y-e.y,t.x-e.x);let o=Math.abs(i*180/Math.PI);return o>180&&(o=360-o),o}checkBackAlignment(t){var e,s,i;try{const o=((e=window.MediaPipeConfig)==null?void 0:e.POSE_LANDMARKS)||{},n=t[o.LEFT_SHOULDER||11],r=t[o.RIGHT_SHOULDER||12],h=t[o.LEFT_HIP||23],c=t[o.RIGHT_HIP||24],u=t[o.LEFT_KNEE||25],p=t[o.RIGHT_KNEE||26],g=t[o.LEFT_ANKLE||27],m=t[o.RIGHT_ANKLE||28],a=M=>M&&(M.visibility==null||M.visibility>.5);if(!a(n)||!a(r)||!a(h)||!a(c)||!a(u)||!a(p))return!1;const l={x:(n.x+r.x)/2,y:(n.y+r.y)/2},d={x:(h.x+c.x)/2,y:(h.y+c.y)/2},T={x:(u.x+p.x)/2,y:(u.y+p.y)/2},y=a(g)&&a(m)?{x:(g.x+m.x)/2,y:(g.y+m.y)/2}:null,E=y||T,_={x:l.x-d.x,y:l.y-d.y},f=E?{x:E.x-d.x,y:E.y-d.y}:null;let w=!1;if(this.exerciseMode==="plank"){let M=-1;if(f){const K=Math.hypot(_.x,_.y)||1,R=Math.hypot(f.x,f.y)||1;M=(_.x*f.x+_.y*f.y)/(K*R)}const P=((s=window.MediaPipeConfig)==null?void 0:s.PLANK_CONFIG)||{},S=Math.abs(Math.max(-1,Math.min(1,M))),A=f?S>=(P.STRAIGHT_ABS_COS_MIN??.9):!1,C=l.x-d.x,L=l.y-d.y,b=Math.abs(Math.atan2(L,C)*180/Math.PI),F=P.HORIZ_MAX_DEG??35,x=b<=F||b>=180-F;let N=!0;if(y){const K=this.calculateAngle(h,u,g),R=this.calculateAngle(c,p,m),H=P.KNEE_MIN_DEG??150;N=K>=H&&R>=H}w=A&&x&&N}else if(this.exerciseMode==="squats"){const M=((i=window.MediaPipeConfig)==null?void 0:i.SQUAT_CONFIG)||{},P=this.calculateAngle(n,h,u),S=this.calculateAngle(r,c,p),A=(P+S)/2,C=M.HIP_ANGLE_MIN??150,L=l.x-d.x,b=l.y-d.y,F=Math.abs(Math.atan2(L,-b)*180/Math.PI),x=M.TORSO_TILT_MAX??45;w=A>=C&&F<=x}else{let M=-1;if(f){const S=Math.hypot(_.x,_.y)||1,A=Math.hypot(f.x,f.y)||1;M=(_.x*f.x+_.y*f.y)/(S*A)}const P=Math.abs(Math.max(-1,Math.min(1,M)));w=f?P>=.9:!1}return console.log(`üèÉ Posture(${this.exerciseMode}): ${w?"GOOD":"BAD"}`),w}catch(o){return console.error("Error checking back alignment:",o),!1}}updatePushupCounter(t){var e,s;try{const i=((e=window.MediaPipeConfig)==null?void 0:e.POSE_LANDMARKS)||{},o=((s=window.MediaPipeConfig)==null?void 0:s.PUSHUP_CONFIG)||{},n=t[i.LEFT_SHOULDER||11],r=t[i.LEFT_ELBOW||13],h=t[i.LEFT_WRIST||15],c=t[i.RIGHT_SHOULDER||12],u=t[i.RIGHT_ELBOW||14],p=t[i.RIGHT_WRIST||16];if(!n||!r||!h||!c||!u||!p)return;const g=this.calculateAngle(n,r,h),m=this.calculateAngle(c,u,p),a=(g+m)/2,l=(n.y+c.y)/2,d=o.ELBOW_ANGLE_DOWN||95,T=o.ELBOW_ANGLE_UP||155,y=o.SHOULDER_HEIGHT_DOWN||.02,E=a<=d||l>=1-y,_=a>=T;this.pushupState==="up"?E&&(this.pushupState="down",this.pushupCount+=1,this.onPushupCount&&this.onPushupCount(this.pushupCount),this.onFormFeedback&&this.onFormFeedback({message:`Push-up ${this.pushupCount}`,type:"success",timestamp:Date.now()})):this.pushupState==="down"&&_&&(this.pushupState="up")}catch(i){console.error("Error updating push-up counter:",i)}}updateSquatCounter(t){var e,s;try{const i=((e=window.MediaPipeConfig)==null?void 0:e.POSE_LANDMARKS)||{},o=((s=window.MediaPipeConfig)==null?void 0:s.SQUAT_CONFIG)||{},n=t[i.LEFT_HIP||23],r=t[i.RIGHT_HIP||24],h=t[i.LEFT_KNEE||25],c=t[i.RIGHT_KNEE||26],u=t[i.LEFT_ANKLE||27],p=t[i.RIGHT_ANKLE||28],g=t[i.LEFT_SHOULDER||11],m=t[i.RIGHT_SHOULDER||12];if(!n||!r||!h||!c||!u||!p||!g||!m)return;const a={x:(n.x+r.x)/2,y:(n.y+r.y)/2},l={x:(h.x+c.x)/2,y:(h.y+c.y)/2},d={x:(u.x+p.x)/2,y:(u.y+p.y)/2},T={x:(g.x+m.x)/2,y:(g.y+m.y)/2},y=this.calculateAngle(n,h,u),E=this.calculateAngle(r,c,p),_=(y+E)/2,f=this.calculateAngle(g,n,h),w=this.calculateAngle(m,r,c),M=(f+w)/2,P=o.KNEE_ANGLE_DOWN??80,S=o.KNEE_ANGLE_UP??165,A=o.HIP_ANGLE_MIN??150,C=a.y,L=l.y,b=C>L,F=C<L;this.pushupState==="up"?b&&(this.pushupState="down",this.pushupCount+=1,this.onPushupCount&&this.onPushupCount(this.pushupCount),this.onFormFeedback&&this.onFormFeedback({message:`Squat ${this.pushupCount}`,type:"success",timestamp:Date.now()})):this.pushupState==="down"&&F&&(this.pushupState="up")}catch(i){console.error("Error updating squat counter:",i)}}updateLungesCounter(t){var e,s;try{const i=((e=window.MediaPipeConfig)==null?void 0:e.POSE_LANDMARKS)||{},o=((s=window.MediaPipeConfig)==null?void 0:s.LUNGES_CONFIG)||{},n=t[i.LEFT_HIP||23],r=t[i.RIGHT_HIP||24],h=t[i.LEFT_KNEE||25],c=t[i.RIGHT_KNEE||26],u=t[i.LEFT_ANKLE||27],p=t[i.RIGHT_ANKLE||28];if(!n||!r||!h||!c||!u||!p)return;const g={x:(n.x+r.x)/2,y:(n.y+r.y)/2},m=this.calculateAngle(n,h,u),a=this.calculateAngle(r,c,p),l=m<a,d=l?h:c,T=l?c:u,y=l?m:a,E=l?a:m,_=g.y>d.y,f=o.FRONT_KNEE_ANGLE_DOWN??85,w=o.FRONT_KNEE_ANGLE_UP??160,M=o.BACK_KNEE_ANGLE_DOWN??90,P=o.BACK_KNEE_ANGLE_UP??150,S=y<=f||E<=M||_,A=y>=w&&E>=P;this.pushupState==="up"?S&&(this.pushupState="down",this.pushupCount+=1,this.onPushupCount&&this.onPushupCount(this.pushupCount),this.onFormFeedback&&this.onFormFeedback({message:`Lunge ${this.pushupCount}`,type:"success",timestamp:Date.now()})):this.pushupState==="down"&&A&&(this.pushupState="up")}catch(i){console.error("Error updating lunges counter:",i)}}updateMountainClimbersCounter(t){var e;try{const s=((e=window.MediaPipeConfig)==null?void 0:e.POSE_LANDMARKS)||{},i=t[s.LEFT_HIP||23],o=t[s.RIGHT_HIP||24],n=t[s.LEFT_KNEE||25],r=t[s.RIGHT_KNEE||26],h=t[s.LEFT_ANKLE||27],c=t[s.RIGHT_ANKLE||28];if(!i||!o||!n||!r||!h||!c)return;const u=Math.abs(n.y-i.y),p=Math.abs(r.y-o.y);this._lastLeftKneeY||(this._lastLeftKneeY=n.y),this._lastRightKneeY||(this._lastRightKneeY=r.y),this._climberState||(this._climberState="neutral"),this._lastClimberTime||(this._lastClimberTime=Date.now());const g=.05,m=250,a=Date.now(),l=n.y-this._lastLeftKneeY,d=r.y-this._lastRightKneeY,T=l>g&&d<-g||l<-g&&d>g;if(this._climberState==="neutral"){if(T&&a-this._lastClimberTime>m&&(this._climberState="moving",this._lastClimberTime=a,this.pushupCount+=1,this.onPushupCount&&this.onPushupCount(this.pushupCount),this.onFormFeedback)){const y=l>d?"Left":"Right";this.onFormFeedback({message:`${y} knee drive - Rep ${this.pushupCount}`,type:"success",timestamp:a})}}else this._climberState==="moving"&&(T||(this._climberState="neutral"));this._lastLeftKneeY=n.y,this._lastRightKneeY=r.y,Math.abs(i.y-o.y)>.1&&this.onFormFeedback&&Math.random()<.1&&this.onFormFeedback({message:"Keep hips level!",type:"warning",timestamp:a})}catch(s){console.error("Error updating mountain climbers counter:",s)}}updateBurpeesCounter(t){var e;try{const s=((e=window.MediaPipeConfig)==null?void 0:e.POSE_LANDMARKS)||{},i=t[s.LEFT_SHOULDER||11],o=t[s.RIGHT_SHOULDER||12],n=t[s.LEFT_HIP||23],r=t[s.RIGHT_HIP||24],h=t[s.LEFT_KNEE||25],c=t[s.RIGHT_KNEE||26],u=t[s.LEFT_ANKLE||27],p=t[s.RIGHT_ANKLE||28];if(!i||!o||!n||!r||!h||!c||!u||!p)return;const g=(i.y+o.y)/2,m=(n.y+r.y)/2,a=(h.y+c.y)/2,l=(u.y+p.y)/2;this._lastAnkleY||(this._lastAnkleY=l),this._lastShoulderY||(this._lastShoulderY=g),this._burpeeState||(this._burpeeState="ready"),this._jumpStartTime||(this._jumpStartTime=Date.now());const d=.05,T=300,y=Date.now(),E=this._lastAnkleY-l,_=this._lastShoulderY-g,f=E>d&&_>d;this._burpeeState==="ready"?f&&y-this._jumpStartTime>T&&(this._burpeeState="jumping",this._jumpStartTime=y,this.pushupCount+=1,this.onPushupCount&&this.onPushupCount(this.pushupCount),this.onFormFeedback&&this.onFormFeedback({message:`Burpee ${this.pushupCount} - Good jump!`,type:"success",timestamp:y})):this._burpeeState==="jumping"&&(f||(this._burpeeState="ready")),this._lastAnkleY=l,this._lastShoulderY=g,E>0&&_<=0&&this.onFormFeedback&&Math.random()<.1&&this.onFormFeedback({message:"Jump with your whole body!",type:"warning",timestamp:y})}catch(s){console.error("Error updating burpees counter:",s)}}playWarningSound(){try{const t=new(window.AudioContext||window.webkitAudioContext),e=t.createOscillator(),s=t.createGain();e.connect(s),s.connect(t.destination),e.frequency.setValueAtTime(800,t.currentTime),e.type="sine",s.gain.setValueAtTime(0,t.currentTime),s.gain.linearRampToValueAtTime(.3,t.currentTime+.1),s.gain.exponentialRampToValueAtTime(.01,t.currentTime+.5),e.start(t.currentTime),e.stop(t.currentTime+.5)}catch(t){console.error("Error playing warning sound:",t)}}drawPoseOverlay(t,e,s,i){var r;if(Math.random()<.05&&console.log("üé® Drawing pose overlay with",((r=e.poseLandmarks)==null?void 0:r.length)||0,"landmarks"),!e.poseLandmarks||!t)return;t.save(),t.clearRect(0,0,s,i);const o=e.poseLandmarks;let n=0;o.forEach((h,c)=>{if(h.visibility&&h.visibility>.5){const u=h.x*s,p=h.y*i;t.beginPath(),t.arc(u,p,6,0,2*Math.PI),t.fillStyle=h.visibility>.7?"#10B981":"#F59E0B",t.fill(),t.strokeStyle="#FFFFFF",t.lineWidth=2,t.stroke(),n++}}),Math.random()<.1&&console.log("‚ú® Drew",n,"landmarks"),this.drawBasicConnections(t,o,s,i),t.restore()}drawBasicConnections(t,e,s,i){const o=[[11,12],[11,13],[13,15],[12,14],[14,16],[11,23],[12,24],[23,24],[23,25],[25,27],[24,26],[26,28]];let n=0;o.forEach(([r,h])=>{const c=e[r],u=e[h];c&&u&&c.visibility>.5&&u.visibility>.5&&(t.beginPath(),t.moveTo(c.x*s,c.y*i),t.lineTo(u.x*s,u.y*i),t.strokeStyle="#3B82F6",t.lineWidth=3,t.stroke(),n++)}),Math.random()<.02&&console.log("‚úÖ Drawing completed!",n,"connections")}resetCounter(){this.pushupCount=0,this.pushupState="up",this.postureStatus="unknown",this.accumulatedCorrectMs=0,this.timerRunning=!1,this.startCorrectTimestampMs=0}getStats(){return{count:this.pushupCount,state:this.pushupState,posture:this.postureStatus,timeSec:Math.floor((this.accumulatedCorrectMs+(this.timerRunning?Date.now()-this.startCorrectTimestampMs:0))/1e3)}}getLastResults(){return this.lastResults}setCallbacks({onPushupCount:t,onPostureChange:e,onFormFeedback:s,onTimeUpdate:i}){this.onPushupCount=t,this.onPostureChange=e,this.onFormFeedback=s,this.onTimeUpdate=i}cleanup(){this.pose&&(this.pose.close(),this.pose=null),this.isInitialized=!1}}export{D as default};
//# sourceMappingURL=poseDetection-DOnXjRU0.js.map
