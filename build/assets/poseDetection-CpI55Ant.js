class R{constructor(){this.pose=null,this.isInitialized=!1,this.pushupState="up",this.pushupCount=0,this.postureStatus="unknown",this.lastWarningTime=0,this.videoDimensionsLogged=!1,this.exerciseMode="pushups",this.accumulatedCorrectMs=0,this.timerRunning=!1,this.startCorrectTimestampMs=0,this.onPushupCount=null,this.onPostureChange=null,this.onFormFeedback=null,this.onTimeUpdate=null}setExerciseMode(e){const s=String(e||"").toLowerCase();s==="plank"?this.exerciseMode="plank":s==="squats"||s==="squat"?this.exerciseMode="squats":s==="lunges"||s==="lunge"?this.exerciseMode="lunges":s==="burpees"||s==="burpee"?this.exerciseMode="burpees":s.includes("mountain")||s.includes("climber")?this.exerciseMode="mountainclimbers":this.exerciseMode="pushups"}async initialize(){var e;try{if(console.log("üöÄ Initializing MediaPipe Pose..."),!window.Pose){console.warn("MediaPipe Pose not loaded yet, waiting...");let t=0;for(;!window.Pose&&t<50;)await new Promise(i=>setTimeout(i,200)),t++,t%10===0&&console.log(`Still waiting for MediaPipe... (${t*200}ms)`);if(!window.Pose)return console.error("MediaPipe Pose failed to load after waiting"),!1}console.log("‚úÖ MediaPipe Pose found in window object"),this.pose=new window.Pose({locateFile:t=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${t}`});const s=((e=window.MediaPipeConfig)==null?void 0:e.POSE_CONFIG)||{modelComplexity:0,smoothLandmarks:!0,enableSegmentation:!1,smoothSegmentation:!1,minDetectionConfidence:.5,minTrackingConfidence:.5};return this.pose.setOptions(s),this.pose.onResults(this.onResults.bind(this)),this.isInitialized=!0,console.log("MediaPipe Pose initialized successfully"),!0}catch(s){return console.error("Failed to initialize MediaPipe Pose:",s),!1}}async processFrame(e){var s;if(!this.isInitialized||!this.pose)return console.log("‚ùå Pose not initialized or missing"),null;try{if(Math.random()<.05&&console.log("üìπ Processing frame..."),e.videoWidth===0||e.videoHeight===0){Math.random()<.1&&console.log("‚è≥ Video dimensions not ready yet");return}if(this.videoDimensionsLogged||(console.log(`üìè Video dimensions: ${e.videoWidth}x${e.videoHeight}`),this.videoDimensionsLogged=!0),e.videoWidth>1920||e.videoHeight>1080){console.log("‚ö†Ô∏è Video too large (>1920x1080), skipping frame");return}await this.pose.send({image:e})}catch(t){if((s=t.message)!=null&&s.includes("memory access out of bounds")){console.warn("üîÑ Memory error, skipping frame");return}console.error("Error processing frame:",t)}}onResults(e){var t,i;if(console.log("üéØ onResults called!",e.poseLandmarks?`Found ${e.poseLandmarks.length} landmarks`:"No landmarks"),this.lastResults=e,!e.poseLandmarks){this.postureStatus="unknown",this.onPostureChange&&this.onPostureChange("unknown",null),this.timerRunning&&(this.accumulatedCorrectMs+=Date.now()-this.startCorrectTimestampMs,this.timerRunning=!1,this.startCorrectTimestampMs=0,this.onTimeUpdate&&this.onTimeUpdate(Math.floor(this.accumulatedCorrectMs/1e3)));return}const s=e.poseLandmarks;if(this.exerciseMode==="squats"||this.exerciseMode==="lunges"||this.exerciseMode==="pushups"||this.exerciseMode==="burpees")this.postureStatus="correct",this.onPostureChange&&this.onPostureChange("correct",s);else{const n=this.checkBackAlignment(s),o=n?"correct":"incorrect";if(o!==this.postureStatus&&(this.postureStatus=o,this.onPostureChange&&this.onPostureChange(this.postureStatus,s)),!n){const r=Date.now(),u=((i=(t=window.MediaPipeConfig)==null?void 0:t.PLANK_CONFIG)==null?void 0:i.WARNING_COOLDOWN)||2e3;r-this.lastWarningTime>u&&(this.playWarningSound(),this.lastWarningTime=r,this.onFormFeedback&&this.onFormFeedback({message:"Dangerous posture - straighten your back!",type:"warning",timestamp:r})),this.exerciseMode==="plank"&&this.timerRunning&&(this.accumulatedCorrectMs+=r-this.startCorrectTimestampMs,this.timerRunning=!1,this.startCorrectTimestampMs=0,this.onTimeUpdate&&this.onTimeUpdate(Math.floor(this.accumulatedCorrectMs/1e3)));return}}if(this.exerciseMode==="plank"){const n=Date.now();this.timerRunning||(this.startCorrectTimestampMs=n,this.timerRunning=!0);const o=this.accumulatedCorrectMs+(n-(this.startCorrectTimestampMs||n)),r=Math.floor(o/1e3);this.onTimeUpdate&&this.onTimeUpdate(r);return}this.exerciseMode==="squats"?this.updateSquatCounter(s):this.exerciseMode==="lunges"?this.updateLungesCounter(s):this.exerciseMode==="burpees"?this.updateBurpeesCounter(s):this.exerciseMode==="mountainclimbers"?this.updateMountainClimbersCounter(s):this.updatePushupCounter(s)}calculateAngle(e,s,t){const i=Math.atan2(t.y-s.y,t.x-s.x)-Math.atan2(e.y-s.y,e.x-s.x);let n=Math.abs(i*180/Math.PI);return n>180&&(n=360-n),n}checkBackAlignment(e){var s;try{const t=((s=window.MediaPipeConfig)==null?void 0:s.POSE_LANDMARKS)||{},i=e[t.LEFT_SHOULDER||11],n=e[t.LEFT_HIP||23],o=e[t.LEFT_ANKLE||27],r=c=>c&&(c.visibility==null||c.visibility>.5);if(!r(i)||!r(n)||!r(o))return!1;const u={x:(i.x+i.x)/2,y:(i.y+i.y)/2},h={x:(n.x+n.x)/2,y:(n.y+n.y)/2},p={x:(o.x+o.x)/2,y:(o.y+o.y)/2}||h,a={x:u.x-h.x,y:u.y-h.y},l=p?{x:p.x-h.x,y:p.y-h.y}:null;let g=!1;if(this.exerciseMode==="plank"){if(!i||!n||!o)return!1;const c=this.calculateAngle(i,n,o),m=160,y=190,d=e[t.LEFT_ELBOW||13],P=e[t.LEFT_WRIST||15];if(!d||!P)return!1;const T=this.calculateAngle(i,d,P),M=150,C=200,E=e[t.LEFT_KNEE||25];if(!E)return!1;const w=this.calculateAngle(n,E,o);g=c>=m&&c<=y&&T>=M&&T<=C&&w>=160&&w<=200}else{let c=-1;if(l){const y=Math.hypot(a.x,a.y)||1,d=Math.hypot(l.x,l.y)||1;c=(a.x*l.x+a.y*l.y)/(y*d)}const m=Math.abs(Math.max(-1,Math.min(1,c)));g=l?m>=.9:!1}return console.log(`üèÉ Posture(${this.exerciseMode}): ${g?"GOOD":"BAD"}`),g}catch(t){return console.error("Error checking back alignment:",t),!1}}updatePushupCounter(e){var s,t;try{const i=((s=window.MediaPipeConfig)==null?void 0:s.POSE_LANDMARKS)||{},n=((t=window.MediaPipeConfig)==null?void 0:t.PUSHUP_CONFIG)||{},o=e[i.LEFT_SHOULDER||11],r=e[i.LEFT_ELBOW||13],u=e[i.LEFT_WRIST||15],h=e[i.RIGHT_ELBOW||14],f=e[i.RIGHT_WRIST||16],p=this.calculateAngle(o,r,u),a=this.calculateAngle(rightShoulder,h,f),l=(p+a)/2,g=150,c=(o.y+rightShoulder.y)/2,m=n.ELBOW_ANGLE_DOWN||95,y=n.ELBOW_ANGLE_UP||155,d=n.SHOULDER_HEIGHT_DOWN||.02,P=l<=m||c>=1-d,T=l>=y;this.pushupState==="up"?P&&(this.pushupState="down",this.pushupCount+=1,this.onPushupCount&&this.onPushupCount(this.pushupCount),this.onFormFeedback&&this.onFormFeedback({message:`Push-up ${this.pushupCount}`,type:"success",timestamp:Date.now()})):this.pushupState==="down"&&T&&(this.pushupState="up")}catch(i){console.error("Error updating push-up counter:",i)}}updateSquatCounter(e){var s,t;try{const i=((s=window.MediaPipeConfig)==null?void 0:s.POSE_LANDMARKS)||{},n=((t=window.MediaPipeConfig)==null?void 0:t.SQUAT_CONFIG)||{},o=e[i.LEFT_HIP||23],r=e[i.RIGHT_HIP||24],u=e[i.LEFT_KNEE||25],h=e[i.RIGHT_KNEE||26],f=e[i.LEFT_ANKLE||27],p=e[i.RIGHT_ANKLE||28],a=e[i.LEFT_SHOULDER||11],l=e[i.RIGHT_SHOULDER||12];if(!o||!r||!u||!h||!f||!p||!a||!l)return;const g={x:(o.x+r.x)/2,y:(o.y+r.y)/2},c={x:(u.x+h.x)/2,y:(u.y+h.y)/2},m={x:(f.x+p.x)/2,y:(f.y+p.y)/2},y={x:(a.x+l.x)/2,y:(a.y+l.y)/2},d=this.calculateAngle(o,u,f),P=this.calculateAngle(r,h,p),T=(d+P)/2,M=this.calculateAngle(a,o,u),C=this.calculateAngle(l,r,h),E=(M+C)/2,w=n.KNEE_ANGLE_DOWN??80,_=n.KNEE_ANGLE_UP??165,L=n.HIP_ANGLE_MIN??150,A=g.y,S=c.y,b=A>S,F=A<S;this.pushupState==="up"?b&&(this.pushupState="down",this.pushupCount+=1,this.onPushupCount&&this.onPushupCount(this.pushupCount),this.onFormFeedback&&this.onFormFeedback({message:`Squat ${this.pushupCount}`,type:"success",timestamp:Date.now()})):this.pushupState==="down"&&F&&(this.pushupState="up")}catch(i){console.error("Error updating squat counter:",i)}}updateLungesCounter(e){var s,t;try{const i=((s=window.MediaPipeConfig)==null?void 0:s.POSE_LANDMARKS)||{},n=((t=window.MediaPipeConfig)==null?void 0:t.LUNGES_CONFIG)||{},o=e[i.LEFT_HIP||23],r=e[i.RIGHT_HIP||24],u=e[i.LEFT_KNEE||25],h=e[i.RIGHT_KNEE||26],f=e[i.LEFT_ANKLE||27],p=e[i.RIGHT_ANKLE||28];if(!o||!r||!u||!h||!f||!p)return;const a={x:(o.x+r.x)/2,y:(o.y+r.y)/2},l=this.calculateAngle(o,u,f),g=this.calculateAngle(r,h,p),c=l<g,m=c?u:h,y=c?h:f,d=c?l:g,P=c?g:l,T=a.y>m.y,M=d<=85||P<=90||T,C=d>=160&&P>=150;this.pushupState==="up"?M&&(this.pushupState="down",this.pushupCount+=1,this.onPushupCount&&this.onPushupCount(this.pushupCount),this.onFormFeedback&&this.onFormFeedback({message:`Lunge ${this.pushupCount}`,type:"success",timestamp:Date.now()})):this.pushupState==="down"&&C&&(this.pushupState="up")}catch(i){console.error("Error updating lunges counter:",i)}}updateMountainClimbersCounter(e){var s;try{const t=((s=window.MediaPipeConfig)==null?void 0:s.POSE_LANDMARKS)||{},i=e[t.LEFT_HIP||23],n=e[t.RIGHT_HIP||24],o=e[t.LEFT_KNEE||25],r=e[t.RIGHT_KNEE||26],u=e[t.LEFT_ANKLE||27],h=e[t.RIGHT_ANKLE||28];if(!i||!n||!o||!r||!u||!h)return;const f=Math.abs(o.y-i.y),p=Math.abs(r.y-n.y);this._lastLeftKneeY||(this._lastLeftKneeY=o.y),this._lastRightKneeY||(this._lastRightKneeY=r.y),this._climberState||(this._climberState="neutral"),this._lastClimberTime||(this._lastClimberTime=Date.now());const a=.05,l=250,g=Date.now(),c=o.y-this._lastLeftKneeY,m=r.y-this._lastRightKneeY,y=c>a&&m<-a||c<-a&&m>a;if(this._climberState==="neutral"){if(y&&g-this._lastClimberTime>l&&(this._climberState="moving",this._lastClimberTime=g,this.pushupCount+=1,this.onPushupCount&&this.onPushupCount(this.pushupCount),this.onFormFeedback)){const d=c>m?"Left":"Right";this.onFormFeedback({message:`${d} knee drive - Rep ${this.pushupCount}`,type:"success",timestamp:g})}}else this._climberState==="moving"&&(y||(this._climberState="neutral"));this._lastLeftKneeY=o.y,this._lastRightKneeY=r.y,Math.abs(i.y-n.y)>.1&&this.onFormFeedback&&Math.random()<.1&&this.onFormFeedback({message:"Keep hips level!",type:"warning",timestamp:g})}catch(t){console.error("Error updating mountain climbers counter:",t)}}updateBurpeesCounter(e){var s;try{const t=((s=window.MediaPipeConfig)==null?void 0:s.POSE_LANDMARKS)||{},i=e[t.NOSE||0],n=e[t.LEFT_WRIST||15],o=e[t.RIGHT_WRIST||16],r=e[t.LEFT_INDEX||19],u=e[t.RIGHT_INDEX||20];if(!i||!n||!o)return;const h=i.y,f=r?r.y:n.y,p=u?u.y:o.y,a=f<h&&p<h;this._burpeeState||(this._burpeeState="ready"),this._burpeeState==="ready"?a&&(this._burpeeState="jumping",this.pushupCount+=1,this.onPushupCount&&this.onPushupCount(this.pushupCount),this.onFormFeedback&&this.onFormFeedback({message:`Burpee ${this.pushupCount} - Hands above head!`,type:"success",timestamp:Date.now()})):this._burpeeState==="jumping"&&(a||(this._burpeeState="ready"))}catch(t){console.error("Error updating burpees counter:",t)}}playWarningSound(){try{const e=new(window.AudioContext||window.webkitAudioContext),s=e.createOscillator(),t=e.createGain();s.connect(t),t.connect(e.destination),s.frequency.setValueAtTime(800,e.currentTime),s.type="sine",t.gain.setValueAtTime(0,e.currentTime),t.gain.linearRampToValueAtTime(.3,e.currentTime+.1),t.gain.exponentialRampToValueAtTime(.01,e.currentTime+.5),s.start(e.currentTime),s.stop(e.currentTime+.5)}catch(e){console.error("Error playing warning sound:",e)}}drawPoseOverlay(e,s,t,i){if(!s.poseLandmarks||!e)return;e.save(),e.clearRect(0,0,t,i);const n=s.poseLandmarks;n.forEach(o=>{if(o.visibility&&o.visibility>.5){const r=o.x*t,u=o.y*i;e.beginPath(),e.arc(r,u,6,0,2*Math.PI),e.fillStyle=o.visibility>.7?"#10B981":"#F59E0B",e.fill(),e.strokeStyle="#FFFFFF",e.lineWidth=2,e.stroke()}}),this.drawBasicConnections(e,n,t,i),e.restore()}drawBasicConnections(e,s,t,i){[[11,12],[11,13],[13,15],[12,14],[14,16],[11,23],[12,24],[23,24],[23,25],[25,27],[24,26],[26,28]].forEach(([o,r])=>{const u=s[o],h=s[r];u&&h&&u.visibility>.5&&h.visibility>.5&&(e.beginPath(),e.moveTo(u.x*t,u.y*i),e.lineTo(h.x*t,h.y*i),e.strokeStyle="#3B82F6",e.lineWidth=3,e.stroke())})}resetCounter(){this.pushupCount=0,this.pushupState="up",this.postureStatus="unknown",this.accumulatedCorrectMs=0,this.timerRunning=!1,this.startCorrectTimestampMs=0}getStats(){return{count:this.pushupCount,state:this.pushupState,posture:this.postureStatus,timeSec:Math.floor((this.accumulatedCorrectMs+(this.timerRunning?Date.now()-this.startCorrectTimestampMs:0))/1e3)}}getLastResults(){return this.lastResults}setCallbacks({onPushupCount:e,onPostureChange:s,onFormFeedback:t,onTimeUpdate:i}){this.onPushupCount=e,this.onPostureChange=s,this.onFormFeedback=t,this.onTimeUpdate=i}cleanup(){this.pose&&(this.pose.close(),this.pose=null),this.isInitialized=!1}}export{R as default};
//# sourceMappingURL=poseDetection-CpI55Ant.js.map
